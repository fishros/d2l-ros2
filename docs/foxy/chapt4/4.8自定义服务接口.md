# 4.5.1 è‡ªå®šä¹‰æœåŠ¡æ¥å£

å¸…é±¼åˆæ¥äº†ï¼Œä¸Šä¸€èŠ‚å°é±¼ç»™å¤§å®¶ä»‹ç»äº†ä»€ä¹ˆæ˜¯æœåŠ¡ï¼Œå¹¶ä¸”ç»™å¤§å®¶ä¸¾äº†æä¸‰å‘æå››å€Ÿé’±åƒéº»è¾£çƒ«ï¼Œå¼ ä¸‰å‘ç‹äºŒä¹°äºŒæ‰‹ä¹¦çš„ä¾‹å­ã€‚ä½œä¸ºROSé•‡çš„åˆ›é€ è€…çš„æˆ‘ä»¬ï¼Œè‚¯å®šè¦æ»¡è¶³æ‘æ°‘ä»¬çš„éœ€æ±‚ã€‚

æ‰€ä»¥æœ¬èŠ‚å°é±¼å°†å¸¦ä½ ä¸€èµ·ï¼Œåˆ›é€ ä¸€ä¸ªå€Ÿé’±æœåŠ¡æ¥å£å’Œä¸€ä¸ªä¹°ä¹¦æœåŠ¡æ¥å£ã€‚

## 1.æœåŠ¡æ¥å£ä»‹ç»

åœ¨4.5åˆ°4.6ç« èŠ‚ä¸­ï¼Œå°é±¼ä»‹ç»äº†æ¥å£å’Œè¯é¢˜æ¥å£çš„æ¦‚å¿µã€‚é‚£æœåŠ¡æ¥å£å’Œè¯é¢˜æ¥å£æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

é‚£å°±è¦çœ‹ï¼Œè¯é¢˜å’ŒæœåŠ¡æœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„äº†ã€‚ä¹‹å‰å°é±¼æ›¾æèµ·è¿‡ï¼š

- è¯é¢˜æ˜¯**å‘å¸ƒè®¢é˜…æ¨¡å‹**ã€‚ä¸»è¦æ˜¯å•å‘ä¼ è¾“æ•°æ®ï¼Œåªèƒ½ç”±å‘å¸ƒè€…å‘å¸ƒï¼Œæ¥æ”¶è€…æ¥æ”¶ï¼ˆåŒä¸€è¯é¢˜ï¼Œå‘å¸ƒè€…æ¥æ”¶è€…éƒ½å¯ä»¥æœ‰å¤šä¸ªï¼‰
- æœåŠ¡æ˜¯**å®¢æˆ·ç«¯æœåŠ¡ç«¯ï¼ˆè¯·æ±‚å“åº”ï¼‰æ¨¡å‹**ã€‚ç”±å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å¤„ç†è¯·æ±‚ï¼Œç„¶åè¿”å›å¤„ç†ç»“æœï¼ˆåŒä¸€æœåŠ¡ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç”±å¤šä¸ªï¼ŒæœåŠ¡ç«¯åªèƒ½æœ‰ä¸€ä¸ªï¼‰

ç”±ä»¥ä¸Šå·®åˆ«æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¯é¢˜é€šä¿¡æ˜¯å•å‘çš„ï¼Œè‡ªå®šä¹‰è¯é¢˜åªéœ€è¦å®šä¹‰**ä¼ è¿‡å»çš„æ•°æ®ç±»å‹**å°±è¡Œï¼Œè€ŒæœåŠ¡æ˜¯åŒå‘çš„ï¼Œæ‰€ä»¥è¦å®šä¹‰**ä¸€å»ä¸€å›ä¸¤ç§æ•°æ®ç±»å‹**ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœåŠ¡çš„æ¶ˆæ¯æ¥å£é•¿ä»€ä¹ˆæ ·å­ï¼Ÿ

æœåŠ¡æ¥å£æ ¼å¼ï¼š`xxx.srv`

```
int64 a
int64 b
---
int64 sum
```

ä¸è¯é¢˜ä¸åŒçš„æ˜¯ï¼Œsrvæ–‡ä»¶æ¯”msgæ–‡ä»¶ä¸­é—´å¤šå‡ºäº†ä¸‰ä¸ª`---`è¿™ä¸‰ä¸ªæ æ å°±æ˜¯åˆ†ç•Œçº¿ï¼Œä¸Šæ–¹çš„æ˜¯å®¢æˆ·ç«¯å‘é€è¯·æ±‚çš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œä¸‹æ–¹çš„æ˜¯æœåŠ¡ç«¯å“åº”ç»“æœçš„æ•°æ®ç»“æ„å®šä¹‰ã€‚

æ˜¯ä¸æ˜¯ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œé‚£å¦‚ä½•åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„æœåŠ¡æ¥å£å‘¢ï¼Ÿå¯ä»¥å‚è€ƒä¸‹é¢çš„æ­¥éª¤ï¼š

- æ–°å»º`srv`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨æ–‡ä»¶å¤¹ä¸‹æ–°å»º`xxx.srv`
- åœ¨`xxx.srv`ä¸‹ç¼–å†™æœåŠ¡æ¥å£å†…å®¹å¹¶ä¿å­˜
- åœ¨`CmakeLists.txt`æ·»åŠ ä¾èµ–å’Œsrvæ–‡ä»¶ç›®å½•
- åœ¨`package.xml`ä¸­æ·»åŠ `xxx.srv`æ‰€éœ€çš„ä¾èµ–
- ç¼–è¯‘åŠŸèƒ½åŒ…å³å¯ç”Ÿæˆ`python`ä¸c++å¤´æ–‡ä»¶

å½“ç„¶åœ¨åšä¸Šé¢çš„æ­¥éª¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚å°±æ˜¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œç¡®å®šå¥½è¯·æ±‚çš„æ•°æ®ç»“æ„å’Œè¿”å›çš„æ•°æ®ç»“æ„ã€‚

## 2.åˆ›å»ºå€Ÿé’±æœåŠ¡æ¥å£

æˆ‘ä»¬ä¾ç„¶æ˜¯åœ¨`village_interfaces`ä¸‹åˆ›å»ºæœåŠ¡æ¥å£ã€‚

### 2.1 ç¡®è®¤æ•°æ®ç»“æ„

å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ ¹æ®æå››çš„éœ€æ±‚æ¥ç¡®å®šæ•°æ®ç»“æ„ã€‚

ä¸Šä¸€èŠ‚ä¸­æå››å¯¹å€Ÿé’±çš„è¦æ±‚å¦‚ä¸‹ï¼š

1. å€Ÿé’±ä¸€å®šè¦æ‰“æ¬ æ¡ï¼Œæ”¶åˆ°æ¬ æ¡æ‰èƒ½ç»™é’±
2. æ¯æ¬¡å€Ÿé’±ä¸èƒ½è¶…è¿‡è‡ªå·±å…¨éƒ¨èµ„é‡‘çš„`10%`ä¸”ä¸€å®šæ˜¯æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æå››å‡å¦‚ç°åœ¨æœ‰100å—é’±ï¼Œé‚£ä¹ˆæœ€å¤šå€Ÿå‡ºå»`100x10%=10`å—é’±

æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œæä¸‰å‘é€å€Ÿé’±è¯·æ±‚çš„æ—¶å€™ä¸€å®šè¦æœ‰æ¬ æ¡ï¼Œæˆ‘ä»¬æƒ³ä¸€ä¸‹ï¼Œæ¬ æ¡ä¸­åº”è¯¥è‡³å°‘åŒ…å«ä¸¤æ¡ä¿¡æ¯

- å€Ÿé’±è€…åå­—ï¼Œå­—ç¬¦ä¸²ç±»å‹ã€å¯ä»¥ç”¨`string`è¡¨ç¤º
- é‡‘é¢ï¼Œæ•´å½¢ï¼Œå¯ä»¥ç”¨`uint32`è¡¨ç¤º

é‚£è¯·æ±‚çš„æ•°æ®ç»“æ„æˆ‘ä»¬å°±å¯ä»¥ç¡®å®šä¸‹æ¥äº†ï¼Œæ¥ç€ç¡®å®šè¿”å›çš„æ•°æ®çš„æ ¼å¼ã€‚

æ—¢ç„¶æ˜¯å€Ÿé’±ï¼Œé‚£æå››å°±æœ‰å¯èƒ½æ‹’ç»ï¼Œä¼šæœ‰å€Ÿé’±å¤±è´¥çš„æƒ…å†µï¼Œæ‰€ä»¥è¿”å›æ•°æ®åº”è¯¥æœ‰è¿™ä¸¤æ¡ä¿¡æ¯ï¼š

- æ˜¯å¦å‡ºå€Ÿï¼šåªæœ‰æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µï¼Œå¸ƒå°”ç±»å‹ï¼ˆ`bool`ï¼‰å¯è¡¨ç¤º
- å‡ºå€Ÿé‡‘é¢ï¼šæ— ç¬¦å·æ•´å½¢ï¼Œå¯ä»¥ç”¨`uint32`è¡¨ç¤ºï¼Œå€Ÿé’±å¤±è´¥æ—¶ä¸º0

### 2.2 åˆ›å»º`srv`æ–‡ä»¶å¤¹åŠ`BorrowMoney.srv`æ¶ˆæ¯æ–‡ä»¶

æ‰“å¼€VsCodeï¼Œç„¶åæ‰“å¼€`town_ws`ï¼Œåœ¨`village_interfaces`ä¸‹æ–°å»ºsrvæ–‡ä»¶å¤¹ã€‚

> åŒæ ·å¤§å®¶å¯ä»¥ä½¿ç”¨é¼ æ ‡å³å‡»æ–°å»ºï¼Œä¸ç”¨è¾“å…¥å‘½ä»¤è¡ŒğŸ˜œ

```shell
cd src/village_interfaces
mkdir srv && cd srv
touch BorrowMoney.srv
```

åˆ›å»ºå®Œæˆåçš„ç›®å½•ç»“æ„

![image-20210811162010736](4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£/imgs/image-20210811162010736.png)

### 2.3 ç¼–å†™æ–‡ä»¶å†…å®¹

æ—¢ç„¶ç¡®å®šäº†å†…å®¹ï¼Œç¼–å†™æ–‡ä»¶å°±å¾ˆç®€å•äº†

```
string name
uint32 money
---
bool success
uint32 money
```

### 2.4ä¿®æ”¹`CMakeLists.txt`

å› ä¸ºåœ¨4.6ä¸­æˆ‘ä»¬å·²ç»æ·»åŠ è¿‡ä¾èµ–`DEPENDENCIES`å’Œ`msg`æ–‡ä»¶äº†ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ·»åŠ ä¸€ä¸ª`srv`å³å¯ã€‚

```cmake
find_package(rosidl_default_generators REQUIRED)
rosidl_generate_interfaces(${PROJECT_NAME}
  #---msg---
  "msg/Novel.msg"
  #---srv---
  "srv/BorrowMoney.srv"
  DEPENDENCIES sensor_msgs
 )
```

éœ€è¦å…³æ³¨çš„æ˜¯è¿™ä¸€è¡Œ`"srv/BorrowMoney.srv"`,æ·»åŠ äº†å¯¹åº”çš„æ–‡ä»¶ä½ç½®ã€‚

### 2.5ä¿®æ”¹`package.xml`

åœ¨4.6èŠ‚æˆ‘ä»¬å·²ç»æ·»åŠ è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸ç”¨æ·»åŠ äº†ï¼Œå¦‚æœæ²¡æœ‰åŠ çš„åŒå­¦å¯ä»¥å†åŠ ä¸€æ¬¡ã€‚

```xml
  <build_depend>sensor_msgs</build_depend>
  <build_depend>rosidl_default_generators</build_depend>
  <exec_depend>rosidl_default_runtime</exec_depend>
  <member_of_group>rosidl_interface_packages</member_of_group>
```

### 2.6ç¼–è¯‘

åœ¨vscodeä¸­ï¼Œä½¿ç”¨`Ctrl+Shift+~`æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œåœ¨`town_ws`ç›®å½•ä¸‹è¾“å…¥ï¼š

```shell
colcon build --packages-select village_interfaces
```

![image-20210811163033796](4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£/imgs/image-20210811163033796.png)

### 2.7æµ‹è¯•

è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨`ros2 interface`æŒ‡ä»¤è¿›è¡Œæµ‹è¯•ã€‚

ä¹‹å‰å·²ç»æµ‹è¯•è¿‡äº†è¯é¢˜äº†ï¼Œè¿™é‡Œå°é±¼å°±åªæ”¾ä¸€ä¸‹æµ‹è¯•æŒ‡ä»¤å’Œæµ‹è¯•ç»“æœã€‚

```
source install/setup.bash 
ros2 interface package village_interfaces
ros2 interface show village_interfaces/srv/BorrowMoney
ros2 interface proto village_interfaces/srv/BorrowMoney 
```

> æ³¨æ„ï¼Œ`ros2 interface proto` è¯¥æŒ‡ä»¤ç›®å‰åªæ˜¾ç¤ºå‡ºè¯·æ±‚éƒ¨åˆ†è¯é¢˜æ•°æ®

![image-20210816145858746](4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£/imgs/image-20210816145858746.png)

## 3.åˆ›å»ºä¹°ä¹¦æœåŠ¡æ¥å£

### 3.1 ç¡®è®¤æ•°æ®ç»“æ„

å’Œåˆ›å»ºå€Ÿé’±æœåŠ¡ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆç¡®å®šç‹äºŒå–ä¹¦çš„æ•°æ®ç»“æ„ã€‚

ä¸Šä¸€èŠ‚ä¸­ç‹äºŒå¯¹å–ä¹¦çš„è¦æ±‚å¦‚ä¸‹ï¼š

1. å¿…é¡»ä¸€æ‰‹äº¤é’±ï¼Œä¸€æ‰‹äº¤è´§ï¼Œçˆ±ä¹°ä¸ä¹°ğŸ˜
2. æ¯æ¬¡ç»™å¤šå°‘é’±å–å¤šå°‘ç« ï¼Œæ¯ç« ä¸€å—é’±ï¼Œå¦‚æœæ‰‹é‡Œçš„å­˜è´§ä¸è¶³ï¼Œå°±ç»§ç»­ç­‰å¾…

æ€»ç»“ä¸€ä¸‹ï¼Œç‹äºŒæä¾›ä¹¦çš„æ—¶å€™ï¼Œä¸€å®šè¦å…ˆç»™é’±æ‰è¡Œï¼Œæ‰€ä»¥å¼ ä¸‰åªéœ€è¦ç»™é’±å°±è¡Œï¼ŒæœåŠ¡çš„è¯·æ±‚æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

- ä¹°ä¹¦çš„é’±ï¼Œæ— ç¬¦å·æ•´å½¢ï¼Œ`uint32`

é‚£ç‹äºŒè¿”å›ä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºç‹äºŒå¯¹åº”çš„æ•°é‡è‰³å¨˜ä¼ å¥‡ï¼Œæ‰€ä»¥ç‹äºŒçš„è¿”å›å°±æ˜¯nç« å°è¯´ã€‚

ä¸€ç« èŠ‚çš„å°è¯´æˆ‘ä»¬å¯ä»¥é‡‡ç”¨`string`æ¥ï¼Œé‚£nç« èŠ‚çš„å°è¯´è¯¥æ€ä¹ˆåŠï¼ŸåŠæ³•å°±æ˜¯ç”¨`string`æ•°ç»„æ¥å®¹çº³å¤šä¸ªç« èŠ‚ã€‚

- æ‰€ä»¥ç‹äºŒçš„è¿”å›æ˜¯ä¸€ä¸ª`string`ç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºå¤šä¸ªç« èŠ‚çš„ä¹¦



### 3.2 åˆ›å»º`srv`æ–‡ä»¶å¤¹åŠ`SellNovel.srv`æ¶ˆæ¯æ–‡ä»¶

ä¸Šé¢æˆ‘ä»¬å·²ç»åˆ›å»ºäº†`srv`ï¼Œè¿™é‡Œç›´æ¥åˆ›å»º`SellNovel.srv`

```
cd src/village_interfaces
cd srv
touch SellNovel.srv
```

åˆ›å»ºå®Œæˆåçš„ç›®å½•ç»“æ„

![image-20210812173303503](4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£/imgs/image-20210812173303503.png)

### 3.3 ç¼–å†™æ–‡ä»¶å†…å®¹

ç”¨æ— ç¬¦å·æ•´å½¢è¡¨ç¤º`money`å¤§å®¶å·²ç»å¾ˆæ¸…æ¥šå¦‚ä½•åšäº†ï¼Œé‚£å¦‚ä½•è¡¨ç¤ºå°è¯´æ•°ç»„å‘¢ï¼Ÿå…¶å®åªéœ€åœ¨ç±»å‹çš„åé¢åŠ ä¸Š`[]`ä¸­æ‹¬å·ã€‚

å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š

```
uint32 money
---
string[] novels
```

è¯·æ±‚æ—¶ç»™é’±ï¼Œè¿”å›å³ä¸ºå¤šç« å°è¯´ã€‚

### 3.4ä¿®æ”¹`CMakeLists.txt`

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œå†æ·»åŠ ä¸Šä¸€è¡Œ`"srv/SellNovel.srv"`ä»£ç å³å¯ï¼š

```
rosidl_generate_interfaces(${PROJECT_NAME}
  #---msg---
  "msg/Novel.msg"
  #---srv---
  "srv/BorrowMoney.srv"
  "srv/SellNovel.srv"
   DEPENDENCIES sensor_msgs
 )
```

### 3.5ä¿®æ”¹`package.xml`

åŒæ ·çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä¿®æ”¹è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸éœ€è¦ä¿®æ”¹äº†ã€‚

### 3.6ç¼–è¯‘

åœ¨vscodeä¸­ï¼Œä½¿ç”¨`Ctrl+Shift+~`æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œåœ¨`town_ws`ç›®å½•ä¸‹è¾“å…¥ï¼š

```shell
colcon build --packages-select village_interfaces
```

![image-20210811163033796](4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£/imgs/image-20210811163033796.png)

### 3.7æµ‹è¯•

è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨`ros2 interface`æŒ‡ä»¤è¿›è¡Œæµ‹è¯•ã€‚

ä¹‹å‰å·²ç»æµ‹è¯•è¿‡äº†è¯é¢˜äº†ï¼Œè¿™é‡Œå°é±¼å°±åªæ”¾ä¸€ä¸‹æµ‹è¯•æŒ‡ä»¤å’Œæµ‹è¯•ç»“æœã€‚

```
source install/setup.bash 
ros2 interface package village_interfaces
ros2 interface show village_interfaces/srv/SellNovel
ros2 interface proto village_interfaces/srv/SellNovel 
```

> æ³¨æ„ï¼Œ`ros2 interface proto`è¯¥æŒ‡ä»¤ç›®å‰åªæ˜¾ç¤ºå‡ºè¯·æ±‚éƒ¨åˆ†è¯é¢˜æ•°æ®

![image-20210816150038830](4.8è‡ªå®šä¹‰æœåŠ¡æ¥å£/imgs/image-20210816150038830.png)

## 4.æ€»ç»“

æœ¬èŠ‚å°é±¼å¸¦å¤§å®¶åˆ›å»ºäº†ç”¨äºå€Ÿé’±å’Œä¹°ä¹¦çš„æœåŠ¡æ¥å£ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬å°±å¼€å§‹ç¼–å†™ä»£ç ï¼Œå®Œæˆå€Ÿé’±æœåŠ¡ã€‚

