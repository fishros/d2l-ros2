# 7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°ä¸å˜æ¢

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°é±¼ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬å­¦ä¹ äº†åæ ‡æè¿°å’Œåæ ‡å˜æ¢çš„ç†è®ºçŸ¥è¯†ï¼Œæœ¬èŠ‚è¯¾æˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åˆ°åŠ¨æ‰‹å®ç°ä¸Šï¼Œé€šè¿‡numpyå®ç°åæ ‡çš„æè¿°å’Œå˜æ¢ï¼ŒåŒæ—¶ç»“åˆROS2é±¼RVIZè¿›è¡Œåæ ‡å…³ç³»å¯è§†åŒ–ä¸æ±‚è§£ã€‚

é€šè¿‡æœ¬èŠ‚ä½ å°†æŒæ¡ï¼š
- ä½¿ç”¨numpyè¡¨ç¤ºä½ç½®çŸ¢é‡å’Œæ—‹è½¬çŸ©é˜µ
- ä½¿ç”¨numpyè¿›è¡Œå¹³ç§»ä¸æ—‹è½¬åæ ‡å˜æ¢
- äº†è§£ROS2ä¸­TF2çš„æ¦‚å¿µ
- ä½¿ç”¨tf2ç›¸å…³CLIå·¥å…·è¿›è¡Œåæ ‡å˜æ¢
- ä½¿ç”¨pythonæ“ä½œTFè¿›è¡Œåæ ‡å˜æ¢

## 1.numpyè¡¨ç¤ºä½å§¿

åœ¨å‰å‡ èŠ‚ä¸­ï¼Œå°é±¼å¸¦ä½ å®‰è£…ä½¿ç”¨äº†ROS2å’ŒMiniCondaï¼Œå¹¶å­¦ä¹ ä½¿ç”¨Numpyè¿›è¡ŒçŸ©é˜µç›¸å…³è¿ç®—çš„éªŒè¯ã€‚

é‚£æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨numpyä¸­çš„çŸ©é˜µè¡¨ç¤ºä½ç½®çŸ¢é‡å’Œæ—‹è½¬çŸ©é˜µå‘¢ï¼Ÿ

### 1.1 ä½ç½®è¡¨ç¤º

ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª3è¡Œ1åˆ—çš„çŸ©é˜µè¡¨ç¤ºäº†ä½ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨numpyä¸­è‡ªç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ ·ä¸€ä¸ªçŸ©é˜µè¡¨ç¤ºã€‚

æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ä¸‹é¢æŒ‡ä»¤æ‰“å¼€jupyter

```shell
jupyter-notebook
```

æ–°å»ºä¸€ä¸ªpython3çš„ä»£ç å¹¶é‡å‘½åï¼Œæ¥ç€åœ¨å•å…ƒæ ¼ä¸­å¯¼å…¥numpy

```
import numpy as np
```

![image-20211105102418250](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211105102418250.png)

#### 1.1.1 ä½ç½®çŸ©é˜µ

ä½¿ç”¨3*1çš„çŸ©é˜µè¡¨ç¤ºä½ç½®ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ²¿ç€xã€yã€zå„å¹³ç§»1ä¸ªå•ä½çš„ä½ç½®çŸ¢é‡ã€‚

```
np.asarray([1.0,1.0,1.0]).reshape(3,1)
```

![image-20211105102746824](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211105102746824.png)

### 1.2 å§¿æ€è¡¨ç¤º

å§¿æ€å¯ä»¥ä½¿ç”¨`3*3`çš„æ—‹è½¬çŸ©é˜µè¡¨ç¤º,`3*3`çš„å•ä½çŸ©é˜µä»£è¡¨æ²¡æœ‰å§¿æ€å˜æ¢ï¼Œæ³¨æ„æ²¡æœ‰å§¿æ€å˜æ¢ä¸æ˜¯é›¶çŸ©é˜µï¼Œè€Œæ˜¯å•ä½çŸ©é˜µã€‚

æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ—‹è½¬çŸ©é˜µï¼Œç”¨è¯¥æ—‹è½¬çŸ©é˜µè¡¨ç¤ºç»•ç€zè½´æ—‹è½¬45åº¦ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```
import math
import numpy as np
theta = math.radians(45)
R_AB = np.asarray([math.cos(theta),-math.sin(theta),0,
                   math.sin(theta),math.cos(theta),0,
                   0,0,1
                  ]).reshape(3,3)
print(R_AB)
```

è¿è¡Œåå¾—åˆ°çš„æ—‹è½¬çŸ©é˜µæ˜¯ä¸æ˜¯å’Œä¸ŠèŠ‚çš„ä¸€æ ·

![image-20211105110244694](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211105110244694.png)

## 2.numpyåæ ‡å˜æ¢

æŒæ¡äº†ä½¿ç”¨numpyè¡¨ç¤ºä½ç½®å’Œå§¿æ€åï¼Œæ¥ç€æˆ‘ä»¬ä½¿ç”¨numpyæ¥å®Œæˆä¸Šä¸€èŠ‚çš„å°ç»ƒä¹ 

### 2.1 é¢˜ç›®

#### å¦‚å›¾ğŸ”“ç¤ºï¼Œå·²çŸ¥ï¼š

![æ‰‹çœ¼ç³»ç»Ÿçš„åæ ‡ç³»å…³ç³»](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211104102656102.png)

1.ç›¸æœºåæ ‡ç³»{C}ä¸ºå‚è€ƒåæ ‡ç³»ï¼Œå·¥å…·åæ ‡ç³»{P}çš„ä½ç½®çŸ¢é‡åœ¨ç›¸æœºåæ ‡ç³»{C}çš„`x,y,z`å„è½´æŠ•å½±ä¸º$2,1,2$ï¼Œå¹¶ä¸”å·¥å…·åæ ‡ç³»å’Œç›¸æœºåæ ‡ç³»å§¿æ€ç›¸åŒã€‚

2.æœºå™¨äººåŸºåæ ‡ç³»{B}ä¸ºå‚è€ƒåæ ‡ç³»ï¼Œç›¸æœºåæ ‡ç³»{C}çš„ä½ç½®çŸ¢é‡åœ¨{B}å„è½´çš„æŠ•å½±ä¸º$0,0,3$ï¼Œåæ ‡ç³»{C}ç»•ç€åæ ‡ç³»{B}çš„xè½´è½¬äº†180åº¦

å¯ä»¥å‚è€ƒä¸‹å›¾çœ‹é¢˜ç›®

![åæ ‡ç³»å…³ç³»å›¾](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211108213832470.png)

#### æ±‚ï¼š

**{B}ä¸ºå‚è€ƒåæ ‡ç³»ï¼Œåæ ‡ç³»{P}çš„ä½ç½®çŸ¢é‡å’Œæ—‹è½¬çŸ©é˜µ**

### 2.2 ä½¿ç”¨numpyæ±‚è§£

#### 2.2.1 æ—‹è½¬çŸ©é˜µæ±‚è§£

è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨å¤åˆåæ ‡å˜æ¢äº†ï¼Œæ ¹æ®åæ ‡å˜æ¢è§„åˆ™æœ‰ï¼š
$$
^B_PR=^B_CR^C_PR
$$
{C}å’Œ{P}å§¿æ€ç›¸åŒï¼Œæ‰€ä»¥$^C_PR$æ˜¯ä¸€ä¸ªå•ä½çŸ©é˜µã€‚åˆå› ä¸º{C}ç»•ç€{B}çš„xæ—‹è½¬äº†180åº¦ï¼Œæ ¹æ®ä¸ŠèŠ‚çš„é‡è¦å…¬å¼2å¯çŸ¥
$$
R(x,\theta)= \begin{bmatrix} 
1 & 0           &          0\\
0 & {cos\theta} & -sin\theta \\
0&{sin\theta} & cos\theta \\

\end{bmatrix} \tag{å°é±¼æç¤ºï¼šé‡è¦æ–¹ç¨‹2}
$$
æ‰€ä»¥$^B_CR$å¯¹åº”çš„ç¨‹åºå¯ä»¥è¿™æ ·å†™

```python
import math
import numpy as np
theta = math.radians(180)
R_BC = np.asarray([1,0,0,
                   0,math.cos(theta),-math.sin(theta),
                   0,math.sin(theta),math.cos(theta)]).reshape(3,3)
```

æ‰€ä»¥$^B_PR$å¯ä»¥ç”¨ç¨‹åºæ±‚å¾—ï¼š

```
R_BP = R_BC*np.identity(3)
print("æ—‹è½¬çŸ©é˜µR_BPï¼š\n",R_BP)
```

![å®Œæ•´ç¨‹åºåŠç»“æœ](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211108224851838.png)

#### 2.2.2 å¹³ç§»çŸ©é˜µæ±‚è§£

æ ¹æ®å¤åˆå˜æ¢è§„åˆ™å¯çŸ¥ï¼š
$$
^B_PP=^B_CR^C_PP+^B_CP
$$
æ ¹æ®æè¿°æœ‰ï¼š$^B_CP=[0,0,3]^T$ã€$^C_PP=[2,1,2]^T$

æ‰€ä»¥å¯ä»¥å†™è¿™æ ·å†™ç¨‹åºï¼š

```python
P_BC = np.asarray([0,0,3]).reshape(3,1)
P_CP = np.asarray([2,1,2]).reshape(3,1)
P_BP = np.add(np.dot(R_BC,P_CP),P_BC)
print("ä½ç½®çŸ¢é‡P_BP:\n",P_BP.T)
```

è¿è¡Œä¸‹ï¼Œå¯ä»¥å¾—åˆ°ç»“æœ

![å®Œæ•´ç»“æœ](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211108231029275.png)

### 2.3 ç»“æœå¯¹æ¯”

ä¸ä¸ŠèŠ‚è¯¾ç­”æ¡ˆä¸€è‡´

ä½ç½®çŸ¢é‡ï¼š$[2,-1,1]^T$

æ—‹è½¬çŸ©é˜µï¼š
$$\begin{bmatrix} 
1 & 0 & 0\\
0 & -1 & 0\\
0 &0 & -1\\
\end{bmatrix} \tag{å°é±¼æç¤ºï¼šé‡è¦æ–¹ç¨‹1}$$



ä»¥ä¸Šå¤§å®¶è·Ÿç€å°é±¼ä¸€èµ·å­¦ä¹ äº†ä½¿ç”¨numpyè¡¨ç¤ºä½ç½®å’Œå§¿æ€ï¼Œå¹¶ä½¿ç”¨äº†numpyæ¥è¿›è¡Œåæ ‡å˜æ¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ROS2ä¸­çš„TFå·¥å…·ä¸å†™ä¸€è¡Œä»£ç è¿›è¡Œåæ ‡å‘å¸ƒï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨RVIZ2ç›´è§‚çš„æŸ¥çœ‹åæ ‡å…³ç³»ã€‚



## 3.tf2ä»‹ç»
TFå³`å˜æ¢`çš„è‹±æ–‡å•è¯`TransForm`çš„ç¼©å†™ã€‚æ‰€ä»¥`ROS`å’Œ`ROS2`ä¸­çš„`TF`å°±æ˜¯æŒ‡å’Œåæ ‡å˜æ¢ç›¸å…³çš„å·¥å…·ã€‚

> åœ¨ææœºå™¨äººå½“ä¸­ï¼Œåæ ‡å˜æ¢ç»å¸¸ç”¨åˆ°ï¼Œæ‰€ä»¥`ROS2`å¸®æˆ‘ä»¬åšäº†ä¸€ä¸ªå¼ºå¤§æ˜“ç”¨çš„TFå·¥å…·

![../../_images/simple_robot.png](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/simple_robot.png)

### 3.1 å‘å¸ƒåæ ‡å…³ç³»

æˆ‘ä»¬å…ˆä½¿ç”¨TF2çš„ç›¸å…³å·¥å…·ï¼Œè§£å†³ä¸Šä¸€èŠ‚çš„æ‰‹çœ¼åæ ‡è½¬æ¢é—®é¢˜ï¼Œç›´è§‚çš„æ„Ÿå—ä¸€ä¸‹TF2çš„å¼ºå¤§ã€‚

è¦æƒ³è®©TFå¸®æˆ‘ä»¬å®Œæˆåæ ‡å˜æ¢ï¼Œæˆ‘ä»¬å°±éœ€è¦å‘Šè¯‰å®ƒåæ ‡å’Œåæ ‡ä¹‹é—´çš„å…³ç³»ã€‚

![æ‰‹çœ¼ç³»ç»Ÿ](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/820a681b891a4719867e0c84a492d85f.png)

æ‹¿ä¸Šé¢çš„æ‰‹çœ¼ç³»ç»Ÿæ¥è¯´ï¼Œæˆ‘ä»¬è¦æƒ³è·å–åˆ°ç›¸æœºçš„åŸºåæ ‡ç³»{B}å’Œå·¥å…·{P}ä¹‹é—´çš„å…³ç³»ï¼Œåªéœ€è¦å°†æœºæ¢°è‡‚å’Œç›¸æœºã€ç›¸æœºå’Œå·¥å…·ä¹‹é—´çš„å…³ç³»å‘Šè¯‰TFå³å¯ã€‚

#### æˆ‘ä»¬å¦‚ä½•å‘Šè¯‰TFï¼Ÿ

å¯ä»¥ä½¿ç”¨tfçš„åæ ‡å¹¿æ’­å·¥å…·è¿›è¡Œå¹¿æ’­åæ ‡å…³ç³»ï¼Œå¹¿æ’­æ—¶éœ€è¦ä¸‰ä¸ªæ•°æ®ï¼š
- çˆ¶åæ ‡ç³»åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰
- å­åæ ‡ç³»åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰
- çˆ¶å­ä¹‹é—´çš„å˜æ¢å…³ç³»ï¼ˆå¹³ç§»å…³ç³»å’Œæ—‹è½¬å…³ç³»ï¼‰

åœ¨ç»ˆç«¯ä¸­è¾“å…¥ï¼š

```
ros2 run tf2_ros static_transform_publisher 
```

æŒ‰`enter`é”®ï¼Œå¯ä»¥çœ‹åˆ°

```
A command line utility for manually sending a transform.
Usage: static_transform_publisher x y z qx qy qz qw frame_id child_frame_id 
OR 
Usage: static_transform_publisher x y z yaw pitch roll frame_id child_frame_id 
```

è¿™æ˜¯è¯¥CLIæ‰€æä¾›çš„ä½¿ç”¨æç¤ºï¼Œå¯ä»¥çœ‹å‡º

ä½¿ç”¨TFå‘å¸ƒä½ç½®å’Œå§¿æ€æ—¶ï¼Œä½ç½®çš„æè¿°ä½¿ç”¨çš„æ˜¯xyzä¸‰ä¸ªå‚æ•°ï¼Œè€Œå§¿æ€çš„æè¿°åˆ™åˆ†ä¸¤ç§

- ç¬¬ä¸€ç§æ˜¯å››å…ƒæ•°å½¢å¼ï¼ˆqx qy qz qwï¼‰
- ç¬¬äºŒç§æ˜¯æ¬§æ‹‰è§’å½¢å¼ï¼ˆyawåèˆªè§’-rz pitchä¿¯ä»°è§’-ry rollæ»šè½¬è§’-rxï¼‰ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ¬§æ‹‰å½¢å¼ï¼Œç»•xè½´æ—‹è½¬é‡‡ç”¨æ¬§æ‹‰è§’ä¸­çš„æ»šè½¬è§’rollæ¥æè¿°ï¼Œæ³¨æ„è§’åº¦å•ä½é‡‡ç”¨å¼§åº¦åˆ¶ã€‚

![image-20220125112120457](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20220125112120457.png)

>  å…³äºæ¬§æ‹‰è§’å’Œå››å…ƒæ•°çš„åŒºåˆ«æˆ‘ä»¬æ”¾åˆ°äº†å§¿æ€çš„å¤šç§è¡¨ç¤ºç« èŠ‚æ¥è®²ã€‚





#### å‘å¸ƒBåˆ°Cçš„ä½å§¿

æ¯”å¦‚é’ˆå¯¹ä¸Šé¢çš„æ‰‹çœ¼è½¬æ¢ï¼Œå¹¿æ’­æœºæ¢°è‡‚åæ ‡ç³»{B}å’Œç›¸æœºåæ ‡ç³»{C}ä¹‹é—´çš„å…³ç³»ã€‚

çˆ¶åæ ‡ç³»çš„åå­—å°±æ˜¯Bï¼Œå­åæ ‡ç³»çš„åå­—æ˜¯Cï¼Œçˆ¶å­ä¹‹é—´çš„å¹³ç§»å…³ç³»æ˜¯`0 0 3`,æ—‹è½¬å…³ç³»æ˜¯ç»•xè½´æ—‹è½¬180åº¦ã€‚

åœ¨ROS2ä¸­å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤å‘å¸ƒå˜æ¢ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ä¸‹é¢çš„æŒ‡ä»¤ï¼š

```
ros2 run tf2_ros static_transform_publisher 0 0 3 0 0 3.14 B C
```
å¦‚æœåœ¨ç»ˆç«¯ä¸­çœ‹åˆ°ä¸‹é¢çš„æç¤ºåˆ™ä»£è¡¨å‘å¸ƒæˆåŠŸ

![å‘å¸ƒä½å§¿å…³ç³»](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/6b0d8be89ab04fbd8d82e9cea3d882c8.png)


#### å‘å¸ƒCåˆ°Pçš„ä½å§¿

æ¥ç€æˆ‘ä»¬å‘å¸ƒåæ ‡ç³»{C}åˆ°åæ ‡ç³»{T}çš„ä½å§¿

å†æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š

```
ros2 run tf2_ros static_transform_publisher 2 1 2 0 0 0 C P
```



### 3.2 å¯è§†åŒ–åæ ‡å˜æ¢

æ‰“å¼€ç»ˆç«¯è¾“å…¥rviz2ï¼Œæ‰“å¼€rviz2ï¼Œæˆ‘ä»¬å°è¯•åœ¨rviz2ä¸­ç›´è§‚çš„çœ‹åˆ°åæ ‡ä¹‹é—´çš„å…³ç³»

#### 3.2.1 è®¾ç½®é»˜è®¤åæ ‡ç³»

åˆšæ‰“å¼€RVIZ2ï¼Œä½ çœ‹åˆ°çš„åº”è¯¥æ˜¯è¿™æ ·ä¸€ä¸ªç•Œé¢
![RVIZ2åˆå§‹åŒ–ç•Œé¢](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/6e43fd3ebffb4436b8486d26c6b72c3b.png)
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çª—å£å·¦è¾¹çš„é…ç½®é€‰é¡¹ï¼Œå…¨å±€é€‰é¡¹é»˜è®¤é€‰æ‹©çš„FixedFrameä¸ºmapï¼Œè¿™ä¸ªmapå°±æ˜¯rviz2é»˜è®¤çš„åæ ‡ç³»çš„åå­—ï¼ŒåŠ¨åŠ¨è„šè¶¾å¤´æƒ³ä¸€ä¸‹æˆ‘ä»¬å¹¶æ²¡æœ‰å‘å¸ƒmapè¿™ä¸ªåæ ‡ç³»ï¼Œæ‰€ä»¥ä¸‹é¢Global Statusä¹Ÿæ˜¯çº¢è‰²çš„é”™è¯¯ã€‚

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨çš„ä¿®æ”¹ä»¥ä¸‹å›ºå®šçš„Frameä¸ºBï¼Œè®©é»˜è®¤çš„åæ ‡ç³»è®¾ç½®æˆæœºæ¢°è‡‚çš„åŸºåæ ‡ç³»{B}ã€‚

![è®¾ç½®é»˜è®¤åæ ‡ç³»](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/f8d9586dac624df482450bb7ea57fa6f.png)

è®¾ç½®å®Œæˆåï¼Œé”™è¯¯ä¹Ÿæ²¡æœ‰äº†ï¼Œå› ä¸ºæ­¤æ—¶çš„ROS2çš„TFä¸­ç¡®ç¡®å®å®æ‰¾åˆ°äº†ä¸€ä¸ªå«åšBçš„åæ ‡ç³»ã€‚



#### 3.2.2 æ·»åŠ TFæ’ä»¶

å³ä½¿æ²¡æœ‰é”™è¯¯ï¼Œç°åœ¨æˆ‘ä»¬è¿˜æ˜¯çœ‹ä¸åˆ°åæ ‡ç³»ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåœ¨å°é±¼çš„åŠ¨æ‰‹å­¦ROS2è¯¾ç¨‹å½“ä¸­ï¼Œå°é±¼è®²è¿‡ï¼ŒRVIZ2æ˜¯ä¸€ä¸ªæ’ä»¶åŒ–çš„è½¯ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ·»åŠ TFç›¸å…³çš„æ’ä»¶æ‰èƒ½çœ‹åˆ°TFæ•°æ®ã€‚ 

ç‚¹å‡»å·¦ä¸‹è§’çš„Addï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©TFç‚¹å‡»OK

![RVIZ2æ’ä»¶é€‰æ‹©](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/e58d92dfda4b4819b987b7ca76785a6a.png)

ä¹‹åä½ åœ¨RVIZ2ä¸­å°±å¯ä»¥çœ‹åˆ°ä¸‹å›¾çš„åæ ‡å…³ç³»

![åæ ‡å…³ç³»æ˜¾ç¤º](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/824ad47cce374f198280e8a47e444999.png)

ç»ˆäºæ˜¾ç¤ºå‡ºæ¥äº†ï¼Œä½†æ˜¯æ²¡æœ‰åå­—åˆå¤ªå°äº†ï¼Œä¿®æ”¹ä¸‹å·¦è¾¹çš„é€‰é¡¹ï¼Œå‹¾é€‰Show Namesï¼Œä¿®æ”¹Marker Scale ä¸º5

![ä¿®æ”¹é€‰é¡¹](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/377a74a2e5d54c0589b79b0deb5d2426.png)

å¦‚æœè§‰å¾—è§†è§’ä¸å¥½ï¼Œå¯ä»¥ä½¿ç”¨é¼ æ ‡å·¦é”®å³é”®ä»¥åŠæŒ‰ä¸‹æ»šè½®æ‹–åŠ¨ä¿®æ”¹ã€‚

### 3.3 ç›‘å¬/è·å–TFå…³ç³»
å‘å¸ƒä¹Ÿå‘å¸ƒäº†ï¼Œçœ‹ä¹Ÿçœ‹äº†ï¼Œæ¥ç€æˆ‘ä»¬å°±æŠŠåæ ‡ç³»ä¹‹é—´çš„å…³ç³»æ‰“å°å‡ºæ¥ï¼Œåªè¦åæ ‡ç³»ä¹‹é—´æ˜¯æœ‰è¿æ¥çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨TFæ±‚å‡ºæ¥ï¼Œä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤å°±å¯ä»¥å¾—åˆ°æœºæ¢°è‡‚åŸºåæ ‡ç³»{B}å’Œå·¥å…·åæ ‡ç³»{P}ä¹‹é—´çš„å…³ç³»ã€‚

æ‰“å¼€ç»ˆç«¯,è¾“å…¥å‘½ä»¤ï¼š

```bash
ros2 run tf2_ros tf2_echo B P
```
![è¾“å‡ºä¸¤ä¸ªåæ ‡ä¹‹é—´å…³ç³»](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/6c85c97787474091acda23a39a66f9d1.png)

å¯ä»¥çœ‹åˆ°ç»ˆç«¯ä¸­ä¸æ–­è¾“å‡ºBå’ŒCä¹‹é—´çš„å¹³ç§»å’Œæ—‹è½¬ï¼Œå¹³ç§»é‡‡ç”¨çš„æ˜¯xyzï¼ŒåŸºæœ¬æ­£ç¡®ï¼Œyå’Œzçš„å¾®å°å·®å¼‚æ˜¯å› ä¸ºæˆ‘ä»¬å‘å¸ƒå˜æ¢æ—¶æ—‹è½¬è¾“å…¥çš„æ˜¯3.14å¹¶ä¸ç²¾ç¡®ã€‚

è‡³äºæ—‹è½¬éƒ¨åˆ†é‡‡ç”¨çš„æ˜¯å››å…ƒæ•°è¡¨ç¤ºï¼Œå…³äºè¿™éƒ¨åˆ†å§¿æ€çš„è¡¨ç¤ºï¼Œå°é±¼åœ¨ä¸‹ä¸€èŠ‚ä¼šè®²ï¼Œå¤§å®¶ä¸å¿…çº ç»“ã€‚

é™¤äº†ä½¿ç”¨TFè·å–å…³ç³»å¤–ï¼Œros2è¿˜æä¾›å¾ˆå¤šå·¥å…·æ¥æŸ¥çœ‹åæ ‡ä¹‹é—´çš„å…³ç³»ï¼Œå¤§å®¶å¯ä»¥åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä¸‹é¢çš„å‘½ä»¤è‡ªè¡Œå°è¯•ã€‚

#### rqt_tf_tree
> 2022-04-26æ›´æ–°çš„ï¼Œè¿™ä¸ªå·¥å…·çš„äºŒè¿›åˆ¶å®‰è£…ç‰ˆæœ¬ä½œè€…3æœˆåº•æ‰å‘å¸ƒï¼Œä¹‹å‰æ²¡æçš„åŸå› æ˜¯éœ€è¦æºç è£…å¤ªéº»çƒ¦äº†

è¿™ä¸ªå·¥å…·éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®‰è£…ä¸‹

```
sudo apt install ros-foxy-rqt-tf-tree
```
å®‰è£…å®Œæˆåï¼Œå†æ¬¡æ‰“å¼€rqtå·¥å…·ï¼Œ`Plugins`->`Visualization`->`TF Tree`



æ¥ç€ä½ å°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¼ºå¤§çš„ï¼Œå‡ ä¹å¯ä»¥å®æ—¶çœ‹åˆ°ç³»ç»Ÿtfæ›´æ–°ä¿¡æ¯çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å¯¹äºåé¢æˆ‘ä»¬è¿›è¡Œå¯¼èˆªå’Œæœºæ¢°è‡‚çš„è°ƒè¯•éå¸¸æœ‰å¸®åŠ©ã€‚

> é•¿çš„ä¸ä¸€æ ·æ²¡å…³ç³»ï¼Œè¿™æ˜¯åé¢è¡¥å……çš„å›¾ã€‚

![image-20220426181252686](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20220426181252686.png)



#### å…¶ä»–å·¥å…·

##### tf2_monitor

æŸ¥çœ‹æ‰€æœ‰çš„å‘å¸ƒè€…å’Œé¢‘ç‡ã€‚
```
ros2 run tf2_ros tf2_monitor 
Gathering data on all frames for 10 seconds...

RESULTS: for all Frames

Frames:
Frame: C, published by <no authority available>, Average Delay: 3001.98, Max Delay: 3001.98
Frame: P, published by <no authority available>, Average Delay: 741.497, Max Delay: 741.497
All Broadcasters:
Node: <no authority available> 5029.14 Hz, Average Delay: 1871.74 Max Delay: 3001.98


RESULTS: for all Frames
Frames:
Frame: C, published by <no authority available>, Average Delay: 3001.98, Max Delay: 3001.98
Frame: P, published by <no authority available>, Average Delay: 741.497, Max Delay: 741.497
All Broadcasters:
Node: <no authority available> 5029.14 Hz, Average Delay: 1871.74 Max Delay: 3001.98


```

##### view_frames.py
å¯ä»¥ç”ŸæˆTFçš„pdfï¼Œç›®å‰ä¹Ÿæœ‰åœ¨çº¿çš„å®æ—¶æŸ¥çœ‹å·¥å…·ã€‚
```
ros2 run tf2_tools view_frames.py 
[INFO] [1636558316.667894410] [view_frames]: Listening to tf data during 5 seconds...
[INFO] [1636558321.702280144] [view_frames]: Generating graph in frames.pdf file...
[INFO] [1636558321.709904442] [view_frames]: Result:tf2_msgs.srv.FrameGraph_Response(frame_yaml="C: \n  parent: 'B'\n  broadcaster: 'default_authority'\n  rate: 10000.000\n  most_recent_transform: 0.000000\n  oldest_transform: 0.000000\n  buffer_length: 0.000\nP: \n  parent: 'C'\n  broadcaster: 'default_authority'\n  rate: 10000.000\n  most_recent_transform: 0.000000\n  oldest_transform: 0.000000\n  buffer_length: 0.000\n")
/opt/ros/foxy/lib/tf2_tools/view_frames.py:75: YAMLLoadWarning: calling yaml.load() without Loader=... is deprecated, as the default Loader is unsafe. Please read https://msg.pyyaml.org/load for full details.
  data = yaml.load(result.frame_yaml)

```

![åæ ‡æ ‘](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/82291e00c53c4711b6328cc4b3a9ce90.png)





é™¤äº†ä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œåæ ‡å…³ç³»çš„å¹¿æ’­å’Œç›‘å¬ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä»£ç æ¥å¹¿æ’­å’Œç›‘å¬ï¼Œæ¥ä¸‹æ¥å°é±¼å°±å¸¦ä½ ä¸€èµ·ç”¨ç¨‹åºæ¥å‘å¸ƒTFå¹¿æ’­å’Œè·å–åæ ‡å…³ç³»ã€‚





## 4.pythonæ“ä½œtf2åæ ‡å˜æ¢

è¿è¡Œå‰é¢å®‰è£…çš„jupyterï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨ä»£ç æ¥æ“ä½œtf

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹TFç›¸å…³çš„æ“ä½œæœ‰å“ªäº›ï¼Ÿ
- å¹¿æ’­ï¼ˆTransformBroadcasterï¼‰ï¼šå°†åæ ‡ç³»é±¼åæ ‡ç³»ä¹‹é—´çš„ä½å§¿æ€å…³ç³»å‘å¸ƒå‡ºå»
- ç›‘å¬ï¼ˆTransformListenerï¼‰ï¼šè·å–åæ ‡ç³»å’Œåæ ‡ç³»ä¹‹é—´çš„ä½å§¿å…³ç³»
- TF(åæ ‡å˜æ¢TransformStamped)å¸§ï¼šå¹¿æ’­å‡ºå»çš„ä¸€ç»„æ•°æ®å¯ä»¥ç§°ä½œä¸€ä¸ªTFå¸§ï¼ŒåŒ…å«çˆ¶åæ ‡ç³»åç§°ã€å­åæ ‡ç³»åç§°ï¼Œçˆ¶åæ ‡ç³»å’Œå­åæ ‡ç³»ä¹‹é—´çš„å…³ç³»

æ¥ç€æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ä»£ç æ¥å®ç°ä¸Šé¢å¯¹TFå¸§çš„å‘å¸ƒå’Œç›‘å¬ã€‚

### 4.1 åæ ‡å˜æ¢å¹¿æ’­

åœ¨è¿›è¡Œåæ ‡å˜æ¢å¹¿æ’­å‰ï¼Œæˆ‘ä»¬æ ¹æ®ä¸¤ä¸ªåæ ‡ç³»ä¹‹é—´çš„å…³ç³»æ˜¯å¦ä¼šéšç€æ—¶é—´å˜åŒ–åˆ†æˆä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š
1. åæ ‡ç³»ä¹‹é—´çš„å…³ç³»ä¸éšæ—¶é—´æ¨ç§»è€Œæ”¹å˜ï¼Œç§°ä¸ºé™æ€åæ ‡å˜æ¢ï¼Œéœ€è¦ä½¿ç”¨é™æ€å¹¿æ’­å‘å¸ƒå™¨ï¼ˆStaticTransformBroadcasterï¼‰å‘å¸ƒã€‚æ¯”å¦‚ï¼šæœºå™¨äººçš„ä¸¤ä¸ªè½®å­ä¹‹é—´å…³ç³»ï¼Œå¯ä»¥è®¤ä¸ºéšæ—¶é—´çš„å˜æ¢å…¶ç›¸å¯¹ä½ç½®ä¸å˜ã€‚
2. åæ ‡ç³»ä¹‹é—´çš„å…³ç³»éšæ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ï¼Œç§°ä¸ºï¼ˆåŠ¨æ€ï¼‰åæ ‡å˜æ¢ï¼Œä½¿ç”¨å¹¿æ’­å‘å¸ƒå™¨ï¼ˆTransformBroadcasterï¼‰å‘å¸ƒåæ ‡å…³ç³»ã€‚æ¯”å¦‚æœºå™¨äººåœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½ç½®ï¼Œå› ä¸ºæœºå™¨äººä¼šåŠ¨ã€‚

æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨æ‰‹çœ¼ç³»ç»Ÿä¸ºä¾‹ï¼Œå°è¯•ä½¿ç”¨å¹¿æ’­å‘å¸ƒå™¨æ¥å‘å¸ƒåæ ‡ç³»ä¹‹é—´çš„å…³ç³»ã€‚
åœ¨æ‰‹çœ¼ç³»ç»Ÿä¸­ï¼Œæœºæ¢°è‡‚åŸºåº§å’Œç›¸æœºåæ ‡ç³»ä¹‹é—´çš„ä½ç½®æ˜¯å›ºå®šä¸å˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é™æ€å¹¿æ’­å‘å¸ƒå™¨æ¥å‘å¸ƒï¼Œè€Œç›¸æœºåæ ‡ç³»ä¸‹å·¥ä»¶çš„ä½ç½®æ˜¯å®æ—¶è¯†åˆ«å¾—åˆ°çš„ï¼Œå…¶å€¼ä¼šéšæ—¶é—´å˜åŒ–ï¼Œæ•…æˆ‘ä»¬ç”¨å¹¿æ’­å‘å¸ƒå™¨æ¥å‘å¸ƒã€‚

#### 4.1.1 é™æ€å¹¿æ’­å‘å¸ƒå™¨

åœ¨jupyterä¸­è¾“å…¥å¹¶è¿è¡Œä»¥ä¸‹ç¨‹åºï¼Œä½¿ç”¨æ–¹å¼å°±åƒros2çš„è¯é¢˜å‘å¸ƒï¼Œåªä¸è¿‡ä¸éœ€è¦æŒ‡åå‘å¸ƒçš„è¯é¢˜ï¼ˆå‘å¸ƒåˆ°ç³»ç»Ÿçš„TFæ ‘ä¸Šï¼‰ã€‚

![image-20211121160026637](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121160026637.png)

![image-20211121154439315](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121154439315.png)

> åŸç¨‹åºåœ°å€ï¼š[tf2_static_tf_publish.ipynb](https://fishros.com/d2lros2foxy/chapt7/7.2.2%E5%8A%A8%E6%89%8B%E5%AD%A6%E7%A9%BA%E9%97%B4%E5%A7%BF%E6%80%81%E6%8F%8F%E8%BF%B0/code/tf2_static_tf_publish.ipynb)

è¿™é‡Œå››å…ƒæ•°çš„å€¼éœ€è¦é€šè¿‡åœ¨çº¿çš„åæ ‡è½¬æ¢è·å–ï¼Œé€‰æ‹©è§’åº¦ï¼Œç»•xè½´æ—‹è½¬`180`ï¼Œä¸Šé¢å°±æ˜¯å¯¹åº”çš„å››å…ƒæ•°ï¼Œ`x,y,z,w`ä¸º`1,0,0,0`

![image-20211121155823712](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121155823712.png)



æœ€åé€šè¿‡åæ ‡ç›‘å¬å·¥å…·å¯ä»¥æŸ¥æ‰¾å‡ºBå’ŒCä¹‹é—´çš„å…³ç³»ï¼š

![image-20211121160308411](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121160308411.png)

> æ³¨æ„è¿™é‡Œè¾“å‡ºçš„At time 0.0 ä»£è¡¨ä»»æ„æ—¶åˆ»

#### 4.1.2 å¹¿æ’­å‘å¸ƒå™¨

æ¥ç€æˆ‘ä»¬æ¥ä½¿ç”¨å¹¿æ’­å‘å¸ƒå™¨å‘å¸ƒCå’Œå·¥å…·Pä¹‹é—´çš„å…³ç³»å¹³ç§»ï¼š` x:2 y:1 z:2  ` æ—‹è½¬:`qx:0 qy:0 qz:0 qw:1`

åªéœ€è¦å°†ä¸Šé¢çš„é™æ€å¹¿æ’­å‘å¸ƒå™¨æ”¹ä¸ºå¹¿æ’­å‘å¸ƒå™¨ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘å¸ƒåæ ‡å˜æ¢æ—¶è¦ä»¥ä¸€å®šçš„é¢‘ç‡å®æ—¶å‘å¸ƒï¼Œè¿™æ ·å½“æˆ‘ä»¬è·å–åæ ‡æ—¶æ‰èƒ½è·å–åˆ°å½“å‰æ—¶åˆ»çš„åæ ‡ï¼ˆæœ‰ç‚¹ä¸å¥½ç†è§£ï¼Œå°±æ˜¯åæ ‡å…³ç³»å’Œæ—¶é—´æœ‰å…³ç³»ï¼‰ã€‚

![image-20211121193141477](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121193141477.png)

> åŸç¨‹åºåœ°å€ï¼š[tf2_tf_publish.ipynb](https://fishros.com/d2lros2foxy/chapt7/7.2.2%E5%8A%A8%E6%89%8B%E5%AD%A6%E7%A9%BA%E9%97%B4%E5%A7%BF%E6%80%81%E6%8F%8F%E8%BF%B0/code/tf2_tf_publish.ipynb)


åŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œè·å–åˆ°Cå’ŒPä¹‹é—´å…³ç³»ã€‚

![image-20211121193859200](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121193859200.png)

ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè·å–åˆ°Bå’ŒPä¹‹é—´å…³ç³»ï¼Œå®Œæˆæ‰‹çœ¼è½¬æ¢

![image-20211121194039404](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121194039404.png)

> æ³¨æ„è¿™é‡Œçš„ç»“æœä¸­çš„æ—¶é—´ï¼šAt time 1637494822.281105208.ä»£è¡¨å…·ä½“çš„æŸä¸€ä¸ªæ—¶åˆ»ï¼Œä¸åŒæ—¶åˆ»åæ ‡ä¹‹é—´çš„å¹³ç§»å’Œæ—‹è½¬å¯ä»¥ä¸åŒ

### 4.2 åæ ‡å˜æ¢ç›‘å¬

æ‰€è°“åæ ‡å˜æ¢ç›‘å¬å°±æ˜¯ç›‘å¬æ•´ä¸ªç³»ç»Ÿçš„åæ ‡å˜æ¢å…³ç³»ã€‚

é€šè¿‡`TransformListener`å³å¯è·å–åˆ°æ•´ä¸ª`tf`ç³»ç»Ÿä¸­çª—å£å¤§å°ä¸º10sçš„åæ ‡å…³ç³»ï¼Œå¹¶ä¸”æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`buffer`ï¼Œ`TransformListener`ä¼šæŠŠæ”¶åˆ°çš„åæ ‡å…³ç³»æ”¾å…¥`buffer`ä¸­ï¼Œæˆ‘ä»¬åé¢å°±å¯ä»¥é€šè¿‡`buffer`çš„`lookup_transform()`å‡½æ•°è·å–åˆ°åæ ‡ä¹‹é—´çš„å…³ç³»ã€‚

![image-20211121202253507](7.2.2åŠ¨æ‰‹å­¦ç©ºé—´å§¿æ€æè¿°/imgs/image-20211121202253507.png)

> åŸç¨‹åºåœ°å€ï¼š[tf2_tf_listener.ipynb](https://fishros.com/d2lros2foxy/chapt7/7.2.2%E5%8A%A8%E6%89%8B%E5%AD%A6%E7%A9%BA%E9%97%B4%E5%A7%BF%E6%80%81%E6%8F%8F%E8%BF%B0/code/tf2_tf_listener.ipynb)

å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ‰“å°çš„ç»“æœå’Œæˆ‘ä»¬ä¸Šé¢ç”¨å‘½ä»¤è¡Œå’Œnumpyè®¡ç®—ç»“æœä¸€è‡´ã€‚



--------------

æŠ€æœ¯äº¤æµ&&é—®é¢˜æ±‚åŠ©ï¼š

- **å¾®ä¿¡å…¬ä¼—å·åŠäº¤æµç¾¤ï¼šé±¼é¦™ROS**
- **å°é±¼å¾®ä¿¡ï¼šAiIotRobot**
- **QQäº¤æµç¾¤ï¼š139707339**
- ç‰ˆæƒä¿æŠ¤ï¼šå·²åŠ å…¥â€œç»´æƒéª‘å£«â€ï¼ˆrightknights.comï¼‰çš„ç‰ˆæƒä¿æŠ¤è®¡åˆ’
